"""
This file contains the test cases for the API views.
"""

from unittest.mock import patch, MagicMock
from django.urls import reverse
from rest_framework import status
from startScan.models import Vulnerability
from utils.test_base import BaseTestCase

__all__ = [
    'TestVulnerabilityViewSet',
    'TestLLMVulnerabilityReportGenerator',
    'TestDeleteVulnerability',
    'TestVulnerabilityReport',
    'TestFetchMostCommonVulnerability',
    'TestCVEDetails',
    'TestFetchMostVulnerable'
]

class TestVulnerabilityViewSet(BaseTestCase):
    """Tests for the Vulnerability ViewSet API."""

    def setUp(self):
        """Set up test environment."""
        super().setUp()
        self.data_generator.create_project_base()
        self.data_generator.create_endpoint()
        self.data_generator.create_vulnerability()

    def test_list_vulnerabilities(self):
        """Test listing vulnerabilities."""
        api_url = reverse("api:vulnerabilities-list")
        response = self.client.get(api_url)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertIn('count', response.data)
        self.assertIn('next', response.data)
        self.assertIn('previous', response.data)
        self.assertIn('results', response.data)
        self.assertIsInstance(response.data['results'][0], dict)
        self.assertGreaterEqual(len(response.data["results"]), 1)
        self.assertEqual(
            response.data["results"][0]["name"],
            self.data_generator.vulnerabilities[0].name,
        )

    def test_list_vulnerabilities_by_scan(self):
        """Test listing vulnerabilities by scan history."""
        api_url = reverse("api:vulnerabilities-list")
        response = self.client.get(
            api_url, {"scan_history": self.data_generator.scan_history.id}
        )
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertGreaterEqual(len(response.data["results"]), 1)
        self.assertEqual(
            response.data["results"][0]["name"],
            self.data_generator.vulnerabilities[0].name,
        )

    def test_list_vulnerabilities_by_domain(self):
        """Test listing vulnerabilities by domain."""
        api_url = reverse("api:vulnerabilities-list")
        response = self.client.get(api_url, {"domain": "example.com"})
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertGreaterEqual(len(response.data["results"]), 1)
        self.assertEqual(
            response.data["results"][0]["name"],
            self.data_generator.vulnerabilities[0].name,
        )

    def test_list_vulnerabilities_by_severity(self):
        """Test listing vulnerabilities by severity."""
        api_url = reverse("api:vulnerabilities-list")
        response = self.client.get(api_url, {"severity": 1})
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertGreaterEqual(len(response.data["results"]), 1)
        self.assertEqual(
            response.data["results"][0]["name"],
            self.data_generator.vulnerabilities[0].name,
        )

class TestLLMVulnerabilityReportGenerator(BaseTestCase):
    """Tests for the LLM Vulnerability Report Generator API."""

    def setUp(self):
        super().setUp()
        self.data_generator.create_project_base()
        self.data_generator.create_endpoint()
        self.data_generator.create_vulnerability()

    @patch("reNgine.tasks.llm_vulnerability_report.apply_async")
    def test_get_vulnerability_report(self, mock_apply_async):
        """Test generating a vulnerability report."""
        mock_task = MagicMock()
        mock_task.wait.return_value = {
            "status": True,
            "description": "Test vulnerability report",
        }
        mock_apply_async.return_value = mock_task
        api_url = reverse("api:llm_vulnerability_report_generator")
        response = self.client.get(
            api_url, {"id": self.data_generator.vulnerabilities[0].id}
        )
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTrue(response.data["status"])
        self.assertEqual(response.data["description"], "Test vulnerability report")

class TestDeleteVulnerability(BaseTestCase):
    """Tests for deleting vulnerabilities."""

    def setUp(self):
        super().setUp()
        self.data_generator.create_project_base()
        self.data_generator.create_endpoint()
        self.data_generator.create_vulnerability()

    def test_delete_vulnerability(self):
        """Test deleting a vulnerability."""
        api_url = reverse("api:delete_vulnerability")
        data = {"vulnerability_ids": [self.data_generator.vulnerabilities[0].id]}
        response = self.client.post(api_url, data)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTrue(response.data["status"])
        self.assertFalse(
            Vulnerability.objects.filter(
                id=self.data_generator.vulnerabilities[0].id
            ).exists()
        )

class TestVulnerabilityReport(BaseTestCase):
    """Test case for vulnerability reporting functionality."""

    def setUp(self):
        """Set up test environment."""
        super().setUp()
        self.data_generator.create_project_full()
        self.data_generator.create_endpoint()
        self.data_generator.create_vulnerability()

    @patch("api.views.send_hackerone_report")
    def test_vulnerability_report(self, mock_send_report):
        """Test sending a vulnerability report."""
        mock_send_report.return_value = True
        url = reverse("api:vulnerability_report")
        response = self.client.get(
            url, {"vulnerability_id": self.data_generator.vulnerabilities[0].id}
        )
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTrue(response.data["status"])

class TestFetchMostCommonVulnerability(BaseTestCase):
    """Test case for the Fetch Most Common Vulnerability API."""

    def setUp(self):
        """Set up test environment."""
        super().setUp()
        self.data_generator.create_project_base()
        self.data_generator.create_endpoint()
        self.data_generator.create_vulnerability()
        self.data_generator.create_vulnerability()

    def test_fetch_most_common_vulnerability(self):
        """Test fetching the most common vulnerability."""
        api_url = reverse("api:fetch_most_common_vulnerability")
        data = {
            "target_id": int(self.data_generator.domain.id),
            "scan_history_id": int(self.data_generator.scan_history.id),
            "slug": self.data_generator.project.slug,
            "limit": 10,
        }
        response = self.client.post(api_url, data)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTrue(response.data["status"])
        self.assertEqual(
            response.data["result"][0]["name"],
            self.data_generator.vulnerabilities[0].name,
        )
        self.assertEqual(response.data["result"][0]["count"], 2)

class TestCVEDetails(BaseTestCase):
    """Test case for the CVE Details API."""

    @patch("requests.get")
    def test_get_cve_details(self, mock_get):
        """Test getting CVE details."""
        mock_get.return_value.status_code = 200
        mock_get.return_value.json.return_value = {
            "id": "CVE-2021-44228",
            "summary": "Log4j vulnerability",
        }
        api_url = reverse("api:cve_details")
        response = self.client.get(api_url, {"cve_id": "CVE-2021-44228"})
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTrue(response.data["status"])
        self.assertEqual(response.data["result"]["id"], "CVE-2021-44228")

    def test_get_cve_details_missing_id(self):
        """Test getting CVE details with missing ID."""
        api_url = reverse("api:cve_details")
        response = self.client.get(api_url)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertFalse(response.data["status"])
        self.assertEqual(response.data["message"], "CVE ID not provided")

class TestFetchMostVulnerable(BaseTestCase):
    """Test case for the Fetch Most Vulnerable API."""

    def setUp(self):
        """Set up test environment."""
        super().setUp()
        self.data_generator.create_project_base()
        self.data_generator.create_endpoint()
        self.data_generator.create_vulnerability()
        self.data_generator.create_vulnerability()

    def test_fetch_most_vulnerable(self):
        """Test fetching the most vulnerable subdomains."""
        api_url = reverse("api:fetch_most_vulnerable")
        data = {
            "target_id": int(self.data_generator.domain.id),
            "scan_history_id": int(self.data_generator.scan_history.id),
            "slug": self.data_generator.project.slug,
            "limit": 10,
        }
        response = self.client.post(api_url, data)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTrue(response.data["status"])
        self.assertEqual(
            response.data["result"][0]["name"], self.data_generator.subdomain.name
        )
        self.assertEqual(response.data["result"][0]["vuln_count"], 2)
